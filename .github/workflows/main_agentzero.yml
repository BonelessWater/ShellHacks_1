name: Deploy Full-Stack App to Azure - AgentZero (Deploy Only)

on:
  push:
    branches:
      - main
      - prod
      # Only deploy when you explicitly mark a commit
      # e.g. git commit -m "feat: xyz [deploy]"
      #      git push
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
        type: choice
        options: [production, staging]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy]'))

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Show deployment info
        run: |
          echo "üöÄ Deploying to: ${{ github.event.inputs.environment || 'production' }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - uses: actions/checkout@v4

      # ---- Frontend build ----
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install & Build React
        working-directory: ./frontend
        run: |
          npm ci || npm install
          npm run build
          echo "‚úÖ React build completed"
          ls -la build | head -20

      # ---- Prepare deploy bundle ----
      - name: Create deployment package
        run: |
          echo "üì¶ Preparing deploy/"

          rm -rf deploy
          mkdir -p deploy/api

          # Frontend: production bits only
          cp package.json package-lock.json deploy/
          cp server.js deploy/
          cp -r frontend/build deploy/build

          # Backend: Python files + requirements (no tests, no __pycache__)
          if [ -f requirements.txt ]; then
            cp requirements.txt deploy/api/requirements.txt
          elif [ -f backend/requirements.txt ]; then
            cp backend/requirements.txt deploy/api/requirements.txt
          fi

          # prefer main.py, fallback to any .py
          if [ -f backend/main.py ]; then
            cp backend/main.py deploy/api/
          fi
          find backend -name "*.py" \
            -not -path "*/__pycache__/*" \
            -not -path "*/tests/*" \
            -not -path "*/test/*" \
            -exec cp -n {} deploy/api/ \;

          # Startup script (uses your content below)
          cat > deploy/startup.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "üöÄ Starting AgentZero - Node.js Primary Architecture"
          echo "üìç Current directory: $(pwd)"
          echo "üìÇ Directory contents:"
          ls -la

          # Respect Azure's PORT if set; default to 3000
          export NODE_ENV=production
          export PORT="${PORT:-3000}"
          export REACT_APP_API_URL="http://localhost:8000"

          # ---------- Node (primary) ----------
          if [ ! -d "node_modules" ]; then
              echo "üì¶ Installing Node.js production dependencies..."
              npm install --production --silent
          else
              echo "‚úÖ Node.js dependencies already installed"
          fi

          # ---------- FastAPI (secondary) ----------
          if [ -d "api" ]; then
              echo "üêç Setting up FastAPI backend..."
              cd api

              echo "üì¶ Installing Python dependencies..."
              if command -v python3 >/dev/null 2>&1; then
                PY=python3
              else
                PY=python
              fi
              $PY -m pip install --upgrade pip --quiet || true
              $PY -m pip install -r requirements.txt --quiet

              echo "üîÑ Starting FastAPI backend on port 8000..."
              $PY -m uvicorn main:app --host 0.0.0.0 --port 8000 --workers 1 &
              FASTAPI_PID=$!
              echo "üêç FastAPI started with PID: $FASTAPI_PID"

              # Optional grace period & soft health check
              sleep 2
              if command -v curl >/dev/null 2>&1; then
                curl -fsS http://localhost:8000/health >/dev/null 2>&1 \
                  && echo "‚úÖ FastAPI backend is healthy" \
                  || echo "‚ö†Ô∏è  FastAPI health check failed (continuing)..."
              fi
              cd ..
          else
              echo "‚ö†Ô∏è  No FastAPI backend found, running Node.js only"
          fi

          # ---------- React build presence ----------
          if [ -d "build" ]; then
              echo "‚úÖ React build directory found"
              ls -la build | head -10
          else
              echo "‚ùå No React build directory found"
              exit 1
          fi

          # ---------- server.js presence ----------
          if [ -f "server.js" ]; then
              echo "‚úÖ Node.js server.js found"
          else
              echo "‚ùå server.js not found"
              exit 1
          fi

          # Clean exit for background processes
          trap 'echo "üõë Stopping services..."; kill ${FASTAPI_PID:-0} 2>/dev/null || true; exit 0' SIGTERM SIGINT

          echo "üü¢ Starting Node.js Express server on port $PORT..."
          echo "üåê NODE_ENV=$NODE_ENV"
          echo "üîó REACT_APP_API_URL=$REACT_APP_API_URL"
          node server.js
          EOF

          chmod +x deploy/startup.sh

          echo "üìã Preview deploy structure:"
          find deploy -maxdepth 2 -type f -name "*.js" -o -name "*.py" -o -name "*.json" -o -name "*.sh" | sed 's/^/ - /' | head -40

      # ---- Azure Login ----
      - name: Login to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_88FBF5A58CF4436E8F8955E200248A41 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_7DE0416DFB4B4CB88EDDCA0CC26BC123 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_AD05817C00C745649FDAAE35BB36A645 }}

      # ---- Deploy to Azure Web App ----
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Agentzero'           # <- must match your Web App name
          slot-name: 'Production'         # or omit if no slots
          package: './deploy'             # push the deploy/ folder
          clean: true
          restart: true
